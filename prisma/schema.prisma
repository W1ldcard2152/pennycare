// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String              @id @default(cuid())
  email         String              @unique
  passwordHash  String
  firstName     String
  lastName      String
  isActive      Boolean             @default(true)

  // Relations
  companyAccess UserCompanyAccess[]

  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
}

model UserCompanyAccess {
  id        String   @id @default(cuid())
  userId    String
  companyId String
  role      String   // 'owner', 'admin', 'payroll', 'viewer'

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
}

// ============================================
// COMPANY SETTINGS
// ============================================

model Company {
  id                String   @id @default(cuid())

  // Company Information
  companyName       String
  legalBusinessName String?
  fein              String?  // Federal Employer Identification Number

  // Contact Information
  address           String?
  city              String?
  state             String?
  zipCode           String?
  phone             String?
  email             String?
  website           String?

  // Business Details
  industryType      String?
  fiscalYearEnd     String?  // e.g., "12-31" for December 31

  // Payroll Settings
  defaultPayPeriod  String?  // "weekly", "biweekly", "semimonthly", "monthly"
  overtimeEnabled   Boolean  @default(true)
  overtimeMultiplier Float   @default(1.5)

  // State Tax IDs (can be expanded for multi-state)
  stateUIClientId   String?  // State Unemployment Insurance Client ID
  stateTaxId        String?  // State Tax ID
  localTaxId        String?  // Local Tax ID (if applicable)
  suiRate           Float?   // NY State Unemployment Insurance rate (employer-specific, 2.1%-9.9%)
  futaRate          Float?   @default(0.6) // Federal Unemployment Tax (0.6% after SUTA credit, on first $7,000)

  // NYC Specific
  nycEmployer       Boolean  @default(false) // Does company have NYC employees?

  // Employee Numbering
  nextEmployeeNumber Int     @default(1) // Auto-incrementing counter for employee numbers (persists even after deletion)

  // Workers Comp
  workersCompPolicy String?
  workersCompCarrier String?

  // Bank Account (for payroll ACH)
  bankName          String?
  bankRoutingNumberEncrypted String?
  bankAccountNumberEncrypted String?

  // Tax Deposit & Reminder Settings
  federalDepositSchedule String  @default("monthly") // "monthly" or "semiweekly"
  reminderLeadDays       Int     @default(7)          // Days before deadline to show warnings

  // PTO/Leave Policies
  defaultPTODays    Int?     @default(0)
  defaultSickDays   Int?     @default(5) // NY requires minimum 40 hours (5 days) for 5-99 employees
  ptoAccrualEnabled Boolean  @default(false)
  ptoAccrualHoursEarned Float? @default(1) // Hours earned
  ptoAccrualHoursWorked Float? @default(40) // Per hours worked (e.g., 1 hour per 40 hours = 1/40)

  // Sick Leave Accrual (NY mandates 1 hour per 30 hours worked)
  sickAccrualEnabled Boolean @default(true) // Mandatory in NY
  sickAccrualHoursEarned Float? @default(1) // Hours earned
  sickAccrualHoursWorked Float? @default(30) // Per hours worked (NY: 1 hour per 30 hours)
  sickAnnualCapHours Float? @default(40) // Annual cap (NY: 40 hours for 5-99 employees)

  // Relations
  userAccess        UserCompanyAccess[]
  employees         Employee[]
  timeEntries       TimeEntry[]
  payrollRecords    PayrollRecord[]
  accounts          Account[]
  transactions      Transaction[]
  vendors           Vendor[]
  expenses          Expense[]
  documentTemplates DocumentTemplate[]
  taxFilings        TaxFiling[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// ============================================
// EMPLOYEE & PAYROLL MODELS
// ============================================

model Employee {
  id                String   @id @default(cuid())
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  firstName         String
  lastName          String
  middleName        String?
  dateOfBirth       DateTime?
  email             String?
  phone             String?
  address           String?
  city              String?
  state             String?
  zipCode           String?

  // Employment details
  employeeNumber    String
  position          String
  employmentType    String   // "full-time" or "part-time"
  department        String?
  hireDate          DateTime
  terminationDate   DateTime?
  isActive          Boolean  @default(true)

  // Pay information
  payType           String   // "hourly" or "salary"
  hourlyRate        Float?
  annualSalary      Float?

  // Tax information (encrypted)
  taxIdEncrypted    String?  // Encrypted SSN

  // Federal Tax Settings
  w4FormType        String?  // "2019_prior" or "2020_later"
  w4FilingStatus    String?  // "single", "married", "head_of_household"
  w4Allowances      Int?     // For 2019 & prior forms
  additionalWithholding Float?
  additionalWithholdingPercentage Float?
  overrideAmount    Float?
  overridePercentage Float?
  federalTaxability String?  // "taxable" or "exempt"
  federalTaxesWithheld Boolean @default(true)
  federalResidency  String?  // "resident" or "nonresident"

  // Social Security & Medicare
  socialSecurityTaxability String? // "taxable" or "exempt"
  medicareTaxability String?       // "taxable" or "exempt"

  // State Tax Settings (NY specific, can be adapted for other states)
  stateFilingStatus String?  // "single", "married", "head_of_household"
  stateResidency    String?  // "resident" or "nonresident"
  stateAllowances   Int?
  stateTaxesWithheld Boolean @default(true)
  stateTaxability   String?  // "taxable" or "exempt"

  // State Unemployment
  unemploymentTaxability String? // "taxable" or "exempt"
  worksiteCode      String?
  dependentHealthInsurance Boolean @default(false)

  // State Disability
  disabilityTaxability String? // "taxable" or "exempt"
  disabilityTaxesWithheld Boolean @default(true)

  // Paid Family Leave
  paidFamilyLeaveTaxability String? // "taxable" or "exempt"
  paidFamilyLeaveTaxesWithheld Boolean @default(true)

  // NYC/Yonkers Local Tax (NY specific)
  nycResident       Boolean  @default(false) // NYC resident withholding
  yonkersResident   Boolean  @default(false) // Yonkers resident withholding
  yonkersNonResident Boolean @default(false) // Yonkers non-resident earnings

  // Workers Compensation
  workersCompClassCode String? // e.g., "8810" for clerical, "5183" for plumbing

  // Pay frequency override (if different from company default)
  payFrequency      String?  // "weekly", "biweekly", "semimonthly", "monthly"

  // Relations
  timeEntries       TimeEntry[]
  deductions        EmployeeDeduction[]
  payrollRecords    PayrollRecord[]
  paymentInfo       PaymentInfo?
  emergencyContact  EmergencyContact?
  documents         EmployeeDocument[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model PaymentInfo {
  id                String   @id @default(cuid())
  employeeId        String   @unique
  employee          Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  paymentMethod     String   // "direct_deposit" or "check"

  // Direct deposit info (encrypted)
  routingNumberEncrypted  String?
  accountNumberEncrypted  String?
  accountType             String?  // "checking" or "savings"
  bankName                String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model EmergencyContact {
  id                String   @id @default(cuid())
  employeeId        String   @unique
  employee          Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  name              String
  relationship      String
  phone             String
  alternatePhone    String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model EmployeeDocument {
  id                String   @id @default(cuid())
  employeeId        String
  employee          Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  documentType      String   // "w4", "i9", "license", "other"
  fileName          String
  filePath          String
  fileSize          Int
  mimeType          String?

  description       String?
  expirationDate    DateTime?
  uploadedBy        String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([employeeId])
  @@index([documentType])
}

model DocumentTemplate {
  id                String   @id @default(cuid())
  companyId         String?  // null = available to all companies (system templates)
  company           Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  documentTypeId    String   // links to DOCUMENT_TYPES
  name              String   // "Federal W-4 Form (2024)"
  fileName          String   // "W-4.pdf"
  filePath          String   // "document-templates/federal/W-4.pdf"
  fileSize          Int
  category          String   // "federal", "state", "company"

  description       String?
  isActive          Boolean  @default(true)
  isSystemTemplate  Boolean  @default(false) // true = provided by system, false = uploaded by company

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([companyId])
  @@index([documentTypeId])
  @@index([category])
}

// Employee Deductions (pre-tax and post-tax)
model EmployeeDeduction {
  id          String   @id @default(cuid())
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  deductionType String   // "401k", "401k_roth", "health_insurance", "dental", "vision", "hsa", "fsa", "life_insurance", "garnishment", "child_support", "loan_repayment", "union_dues", "other"
  name          String   // Display name, e.g., "401(k) Contribution", "Health Insurance Premium"

  // Amount can be fixed or percentage
  amountType    String   // "fixed" or "percentage"
  amount        Float    // Dollar amount or percentage (e.g., 6 for 6%)

  // Pre-tax vs post-tax
  preTax        Boolean  @default(true) // true = pre-tax (reduces taxable income), false = post-tax

  // Limits
  annualLimit   Float?   // Annual max (e.g., $23,000 for 401k in 2026)
  ytdAmount     Float    @default(0) // Year-to-date total deducted

  // For garnishments
  caseNumber    String?  // Court case number for garnishments
  totalOwed     Float?   // Total amount owed (for garnishments/loans)
  remainingBalance Float? // Remaining balance

  isActive      Boolean  @default(true)
  effectiveDate DateTime @default(now())
  endDate       DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([employeeId])
  @@index([deductionType])
}

model TimeEntry {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  date        DateTime
  hoursWorked Float
  overtimeHours Float  @default(0)
  notes       String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId, employeeId, date])
  @@index([employeeId, date])
}

model PayrollRecord {
  id              String   @id @default(cuid())
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  payPeriodStart  DateTime
  payPeriodEnd    DateTime
  payDate         DateTime

  // Earnings
  regularHours    Float
  overtimeHours   Float    @default(0)
  regularPay      Float
  overtimePay     Float    @default(0)
  otherEarnings   Float    @default(0) // Bonuses, commissions, etc.
  grossPay        Float

  // Pre-tax Deductions (reduce taxable income)
  preTax401k      Float    @default(0)
  preTaxHealthIns Float    @default(0)
  preTaxDental    Float    @default(0)
  preTaxVision    Float    @default(0)
  preTaxHSA       Float    @default(0)
  preTaxFSA       Float    @default(0)
  preTaxOther     Float    @default(0)
  totalPreTaxDeductions Float @default(0)

  // Taxable wages (grossPay - totalPreTaxDeductions)
  taxableWages    Float?

  // Employee Tax Withholdings
  federalTax      Float
  stateTax        Float    // NY State income tax
  localTax        Float    @default(0) // NYC or Yonkers
  socialSecurity  Float
  medicare        Float
  additionalMedicare Float @default(0) // 0.9% on wages over $200k
  nySDI           Float    @default(0) // NY State Disability Insurance
  nyPFL           Float    @default(0) // NY Paid Family Leave
  totalTaxWithholdings Float @default(0)

  // Post-tax Deductions
  postTaxRoth401k Float    @default(0)
  garnishments    Float    @default(0)
  childSupport    Float    @default(0)
  loanRepayments  Float    @default(0)
  postTaxOther    Float    @default(0)
  totalPostTaxDeductions Float @default(0)

  // Total deductions and net pay
  totalDeductions Float
  netPay          Float

  // Employer Taxes & Contributions (for tax liability tracking)
  employerSocialSecurity Float @default(0)
  employerMedicare Float    @default(0)
  employerSUI      Float    @default(0) // NY State Unemployment Insurance
  employerFUTA     Float    @default(0) // Federal Unemployment Tax
  employerWorkersComp Float @default(0)
  employerHealthIns Float   @default(0) // Employer portion of health insurance
  totalEmployerCost Float   @default(0)

  // YTD totals (at time of this payroll)
  ytdGrossPay     Float    @default(0)
  ytdFederalTax   Float    @default(0)
  ytdStateTax     Float    @default(0)
  ytdSocialSecurity Float  @default(0)
  ytdMedicare     Float    @default(0)
  ytdNetPay       Float    @default(0)

  notes           String?
  isPaid          Boolean  @default(false)
  paidDate        DateTime?
  paymentMethod   String?  // "direct_deposit" or "check"
  checkNumber     String?  // If paid by check

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([companyId, employeeId, payPeriodStart])
  @@index([employeeId, payPeriodStart])
  @@index([payDate])
}

// ============================================
// BOOKKEEPING MODELS
// ============================================

model Account {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  code        String
  name        String
  type        String   // "asset", "liability", "equity", "revenue", "expense"
  subtype     String?  // "current_asset", "fixed_asset", "current_liability", etc.
  description String?

  isActive    Boolean  @default(true)

  // Relations
  debitTransactions  Transaction[] @relation("DebitAccount")
  creditTransactions Transaction[] @relation("CreditAccount")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([companyId, code])
  @@index([companyId])
}

model Transaction {
  id            String   @id @default(cuid())
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  date          DateTime
  description   String
  referenceNumber String?

  // Double-entry bookkeeping
  debitAccountId  String
  debitAccount    Account  @relation("DebitAccount", fields: [debitAccountId], references: [id])
  creditAccountId String
  creditAccount   Account  @relation("CreditAccount", fields: [creditAccountId], references: [id])

  amount        Float

  // Optional categorization
  category      String?
  tags          String?  // JSON array of tags

  // Reconciliation
  isReconciled  Boolean  @default(false)
  reconciledDate DateTime?

  notes         String?
  attachments   String?  // JSON array of file paths

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([companyId, date])
  @@index([date])
  @@index([debitAccountId])
  @@index([creditAccountId])
}

model Vendor {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  name        String
  email       String?
  phone       String?
  address     String?
  city        String?
  state       String?
  zipCode     String?

  taxId       String?

  // Relations
  expenses    Expense[]

  isActive    Boolean  @default(true)
  notes       String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId])
}

model Expense {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  date        DateTime
  vendorId    String?
  vendor      Vendor?  @relation(fields: [vendorId], references: [id])

  description String
  category    String   // "parts", "supplies", "utilities", "rent", etc.
  amount      Float

  paymentMethod String? // "cash", "check", "card", "transfer"
  referenceNumber String?

  isPaid      Boolean  @default(false)
  paidDate    DateTime?

  notes       String?
  attachments String?  // JSON array of file paths

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId, date])
  @@index([date])
  @@index([category])
  @@index([vendorId])
}

// ============================================
// TAX FILING STATUS TRACKING
// ============================================

model TaxFiling {
  id                 String    @id @default(cuid())
  companyId          String
  company            Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  formType           String    // "941", "nys45", "940", "w2"
  year               Int
  quarter            Int?      // 1-4 for quarterly forms, null for annual

  status             String    @default("pending") // "pending", "filed", "extended"
  filedDate          DateTime?
  confirmationNumber String?
  notes              String?

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@unique([companyId, formType, year, quarter])
  @@index([companyId])
}
